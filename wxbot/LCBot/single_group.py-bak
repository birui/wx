#!/usr/bin/env python3
# coding: utf-8
import mysql_config as cfg
import pymysql
import sys
import time
import pickle
import os
from apscheduler.schedulers.background import BackgroundScheduler
from datetime import datetime
import django

# sys.path.append('/Users/admin/python/wxpy/wx')
# os.environ['DJANGO_SETTINGS_MODULE'] = 'wx.settings'

pathname = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, pathname)
sys.path.insert(0, os.path.abspath(os.path.join(pathname, '../../')))
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "wx.settings")

django.setup()

#----------------Use Django Mysql model----------------
from wxbot.models import *

"""
åŠŸèƒ½è¯´æ˜ï¼š
1. ç”¨æˆ·æ— éœ€å‘é€å…³é”®è¯ï¼Œæ·»åŠ å¥½å‹åï¼Œè‡ªåŠ¨å‘é€é‚€è¯·æ¶ˆæ¯
2. æ·»åŠ å¥½å‹åï¼Œä¼šè‡ªåŠ¨å‘é€å›å¤è¯­ï¼ˆä¸‹æ–¹å¯ä¿®æ”¹ï¼‰
3. ç”¨æˆ·è¿›ç¾¤åï¼Œè‡ªåŠ¨å‘é€ç›¸å…³çš„é‚€è¯·ä¿¡æ¯ã€‚
"""
"""
å®šä¹‰åŒºï¼Œä¸‹æ–¹æ•°æ®ä¿®æ”¹ä¸ºä½ è‡ªå·±å¯¹åº”çš„å†…å®¹
"""
# æ¬¢è¿è¯­ï¼Œ{} ä¼šå˜æˆæ–°å…¥ç¾¤ç”¨æˆ·çš„æ˜µç§°
welcome_text = '''ğŸ‰ æ¬¢è¿ @{} çš„åŠ å…¥ï¼
ğŸ˜ƒ æœ‰é—®é¢˜è¯·ç§èŠ @æ¯•é”
'''

# å›å¤è¯­ï¼Œåœ¨å‘é€ç¾¤é‚€è¯·åä¼šå›å¤è¿™ä¸ª
reply_text = """ä½ å¥½ï¼Œæ¬¢è¿åŠ å…¥â€˜coohuaæµ‹è¯•â€™
ç¾¤è§„æ˜¯ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
"""

# ç¾¤å
group_name = 'coohuaæµ‹è¯•'

"""
ä»£ç åŒºï¼Œä¸‹æ–¹çš„å†…å®¹ä¸è¦ä¿®æ”¹
"""
from wxpy import *
import re
# False
bot = Bot('bot.pkl', console_qr=False)
# bot2 = Bot('bot2.pkl', console_qr=False)
target_group = bot.groups().search(group_name)[0]
# target_group = bot2.groups().search(group_name)[0]

# ç¾¤æˆå‘˜ä¸ªæ•°
print(len(target_group))

'''
é‚€è¯·æ¶ˆæ¯å¤„ç†
'''


def get_new_member_name(msg):
    # itchat 1.2.32 ç‰ˆæœ¬æœªæ ¼å¼åŒ–ç¾¤ä¸­çš„ Note æ¶ˆæ¯
    from itchat.utils import msg_formatter
    msg_formatter(msg.raw, 'Text')

    for rp in rp_new_member_name:
        match = rp.search(msg.text)
        if match:
            return match.group(1)


'''
é‚€è¯·ä¿¡æ¯å¤„ç†
'''
rp_new_member_name = (
    re.compile(r'^"(.+)"é€šè¿‡'),
    re.compile(r'é‚€è¯·"(.+)"åŠ å…¥'),
)

'''
å¤„ç†åŠ å¥½å‹è¯·æ±‚ä¿¡æ¯ã€‚
å¦‚æœéªŒè¯ä¿¡æ¯æ–‡æœ¬æ˜¯å­—å…¸çš„é”®å€¼ä¹‹ä¸€ï¼Œåˆ™å°è¯•æ‹‰ç¾¤ã€‚
'''

# è‡ªåŠ¨æ¥æ”¶å¥½å‹è¯·æ±‚


@bot.register(msg_types=FRIENDS)  # æ³¨å†Œå¥½å‹è¯·æ±‚æ¶ˆæ¯
def new_friends(msg):
    user = msg.card.accept()  # æ¥å—å¥½å‹ (msg.card ä¸ºè¯¥è¯·æ±‚çš„ç”¨æˆ·å¯¹è±¡)
    target_group.add_members(user, use_invitation=True)  # useræ˜¯è¦åŠ å…¥çš„ç”¨æˆ·ï¼Œuse_invitation â€“ ä½¿ç”¨å‘é€é‚€è¯·çš„æ–¹å¼
    user.send(reply_text)

# åŠ ç¾¤ls
#


@bot.register(target_group, NOTE)
def send_msg(group_msg):
    # ä¸Šæ¬¡å‘å…¬å‘Šæ—¶é—´
    time_tamp = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
    conn = pymysql.connect(host=cfg.mysql['host'], user=cfg.mysql['user'], passwd=cfg.mysql['passwd'], db=cfg.mysql['db'], port=cfg.mysql['port'], charset="utf8")
    cur = conn.cursor()
    if os.path.exists('last_time.pkl'):
        pkl_file = open('last_time.pkl', 'rb')
        last_time_dic = pickle.load(pkl_file)
        last_time = last_time_dic['last_time']
        sql = "select count(*) from wx_user where create_time > '{0}';" .format(last_time)
        cur.execute(sql)
        count_users = cur.fetchall()[0][0]
        print('======>', count_users, '=======', last_time, '----', sql)
        # ä¸Šæ¬¡å‘å…¬å‘Šä»¥æ¥å¦‚æœæœ‰7ä¸ªæ–°äººè¿›ç¾¤å°±å†å‘ä¸€æ¬¡å…¬å‘Š
        # print('send msg!!!===>{0}' .format(last_time))
        if int(count_users) > 7:
            print('send msg!!!!===>{0}' .format(last_time))
            target_group.send('å…¬å‘Šï¼š{0}' .format(group_msg))  # å‘é€ä¿¡æ¯åˆ°ç¾¤
            # å‘å®Œå…¬å‘Šæ”¹æ—¶é—´
            # last_time['last_time'] = time_tamp
            # pickle.dump(last_time, pkl_file)

    else:
        last_time = {'last_time': time_tamp}
        pkl_file = open('last_time.pkl', 'wb')
        pickle.dump(last_time, pkl_file)

    pkl_file.close()
    conn.commit()
    cur.close()
    conn.close()

# å®šæ—¶ä»»åŠ¡


@bot.register(target_group, NOTE)
def tick():
    target_group.send('Tick! The time is: %s' % datetime.now())
    print(datetime.now())


scheduler = BackgroundScheduler()
scheduler.add_job(tick, 'cron', day_of_week='0-6', minute='*/2')
scheduler.start()


@bot.register(target_group, NOTE)
def welcome(msg):
    name = get_new_member_name(msg)
    if name:
        # å°†åˆšåˆšå…¥ç¾¤çš„ç”¨æˆ·æ·»åŠ åˆ°æ•°æ®åº“
        conn = pymysql.connect(host=cfg.mysql['host'], user=cfg.mysql['user'], passwd=cfg.mysql['passwd'], db=cfg.mysql['db'], port=cfg.mysql['port'], charset="utf8")
        cur = conn.cursor()
        # print(type(name), type(group_name))
        group_owner = bot
        sql1 = "insert into wx_user(name, group_name, group_own) values('{0}', '{1}','{2}') ;" .format(name, group_name, group_owner)
        cur.execute(sql1)
        # domain = cur.fetchall()
        # 1.å¦‚æœè¾¾åˆ°60äººä¸€ä¸ªç¾¤åˆ™è‡ªåŠ¨å»ºç¾¤
        # 2.å¦‚æœæ–°äººè¾¾åˆ°7ä¸ªå°±å‘ä¸€æ¬¡å…¬å‘Š
        send_msg('æ–°äººè¾¾åˆ°7ï¼šè®¨åŒï¼è®¨åŒ----å…¬å‘Štest')
        conn.commit()
        cur.close()
        conn.close()
        # å‘é€æ¬¢è¿ä¿¡æ¯
        return welcome_text.format(name)

# target_group.send('Hello, WeChat!') å‘é€ä¿¡æ¯åˆ°ç¾¤

#======å¤šå¼€=====

#
# @bot2.register(msg_types=FRIENDS)  # æ³¨å†Œå¥½å‹è¯·æ±‚æ¶ˆæ¯
# def new_friends(msg):
#     user = msg.card.accept()  # æ¥å—å¥½å‹ (msg.card ä¸ºè¯¥è¯·æ±‚çš„ç”¨æˆ·å¯¹è±¡)
#     target_group.add_members(user, use_invitation=True)  # useræ˜¯è¦åŠ å…¥çš„ç”¨æˆ·ï¼Œuse_invitation â€“ ä½¿ç”¨å‘é€é‚€è¯·çš„æ–¹å¼
#     user.send(reply_text)
#
#
# @bot2.register(target_group, NOTE)
# def welcome(msg):
#     name = get_new_member_name(msg)
#     if name:
#         return welcome_text.format(name)


embed()
